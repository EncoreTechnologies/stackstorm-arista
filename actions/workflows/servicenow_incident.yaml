version: '2.0'

arista.servicenow_incident:
  type: direct
  input:
    - hosts
    - sys_id

  tasks:
    facts:
      action: arista.inventory
      input:
        hosts: "{{ _.hosts }}"
      publish:
        facts: "{{ task('facts').result.facts }}"
      on-success:
        - logs
        
    logs:
      action: arista.logs
      input:
        hosts: "{{ _.hosts }}"
      publish:
        logs: "{{ task('logs').result.result }}"
      on-success:
        - ip_route

    ip_route:
      action: arista.cli
      input:
        hosts: "{{ _.hosts }}"
        command: "show ip route"
        raw: true
      publish:
        ip_route: "{{ task('ip_route').result.result }}"
      on-success:
        - bgp_summary

    bgp_summary:
      action: arista.cli
      input:
        hosts: "{{ _.hosts }}"
        command: "show ip bgp summary"
        raw: true
      publish:
        bgp_summary: "{{ task('bgp_summary').result.result }}"
      on-success:
        - servicenow_update

    servicenow_update:
      action: servicenow.update
      input:
        table: incident
        sysid: "{{ _.sys_id }}"
        payload:
          comments: |
            [code]
            <h3>FACTS</h3>
            <pre><code>{{ to_yaml_string(_.facts) }}</code></pre>
        
            <h3>LOGS</h3>
            {% for host_logs in _.logs  %}
            <h5>{{ host_logs.host }}</h5>
            <pre><code>{{ host_logs.result | replace('\\\\\\\\n', '\n') }}</code></pre>
            {% endfor -%}

            <h3>show ip route</h3>
            {% for host_routes in _.ip_route  %}
            <h5>{{ host_routes.host }}</h5>
            <pre><code>{{ host_routes.result | replace('\\\\n', '\n') }}</code></pre>
            {% endfor -%}

            <h3>show ip bgp summary</h3>
            {% for host_bgp in _.bgp_summary  %}
            <h5>{{ host_bgp.host }}</h5>
            <pre><code>{{ host_bgp.result | replace('\\\\n', '\n') }}</code></pre>
            {% endfor -%}
