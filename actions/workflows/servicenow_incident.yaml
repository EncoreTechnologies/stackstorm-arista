version: '1.0'

input:
  - hosts
  - sys_id

tasks:
  facts:
    action: arista.inventory
    input:
      hosts: "{{ ctx().hosts }}"
    next:
      - when: "{{ succeeded() }}"
        publish:
          - facts: "{{ result().output.facts }}"
        do: logs
      
  logs:
    action: arista.logs
    input:
      hosts: "{{ ctx().hosts }}"
    next:
      - when: "{{ succeeded() }}"
        publish:
          - logs: "{{ result().output.result }}"
        do: ip_route

  ip_route:
    action: arista.cli
    input:
      hosts: "{{ ctx().hosts }}"
      command: "show ip route"
      raw: true
    next:
      - when: "{{ succeeded() }}"
        publish:
          - ip_route: "{{ result().output.result }}"
        do: bgp_summary

  bgp_summary:
    action: arista.cli
    input:
      hosts: "{{ ctx().hosts }}"
      command: "show ip bgp summary"
      raw: true
    next:
      - when: "{{ succeeded() }}"
        publish:
          - bgp_summary: "{{ result().output.result }}"
        do: servicenow_update

  servicenow_update:
    action: servicenow.update
    input:
      table: incident
      sysid: "{{ ctx().sys_id }}"
      payload:
        comments: |
          [code]
          <h2>FACTS</h2>
          <pre><code>{{ ctx().facts }}</code></pre>
      
          [/code]
