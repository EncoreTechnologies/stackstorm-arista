version: '1.0'

input:
  - hosts
  - sys_id

tasks:
  facts:
    action: arista.inventory
    input:
      hosts: "{{ ctx().hosts }}"
    next:
      - when: "{{ succeeded() }}"
        publish:
          - facts: "{{ result().facts }}"
        do: logs
      
  logs:
    action: arista.logs
    input:
      hosts: "{{ _.hosts }}"
    next:
      - when: "{{ succeeded() }}"
        publish:
          - facts: "{{ result().result }}"
        do: ip_route

  ip_route:
    action: arista.cli
    input:
      hosts: "{{ _.hosts }}"
      command: "show ip route"
      raw: true
    next:
      - when: "{{ succeeded() }}"
        publish:
          - facts: "{{ result().result }}"
        do: bgp_summary

  bgp_summary:
    action: arista.cli
    input:
      hosts: "{{ _.hosts }}"
      command: "show ip bgp summary"
      raw: true
    next:
      - when: "{{ succeeded() }}"
        publish:
          - facts: "{{ result().result }}"
        do: servicenow_update

  servicenow_update:
    action: servicenow.update
    input:
      table: incident
      sysid: "{{ _.sys_id }}"
      payload:
        comments: |
          [code]
          <h2>FACTS</h2>
          <pre><code>{{ to_yaml_string(_.facts) | replace('\n', '<br/>') }}</code></pre>
      
          <h2>LOGS</h2>
          {% for host_logs in _.logs  %}
          <h4>{{ host_logs.host }}</h4>
          <pre><code>{{ host_logs.result | replace('\\\\\\\\n', '<br/>') }}</code></pre>
          {% endfor -%}

          <h2>show ip route</h2>
          {% for host_routes in _.ip_route  %}
          <h4>{{ host_routes.host }}</h4>
          <pre><code>{{ host_routes.result | replace('\\\\n', '<br/>') }}</code></pre>
          {% endfor -%}

          <h2>show ip bgp summary</h2>
          {% for host_bgp in _.bgp_summary  %}
          <h4>{{ host_bgp.host }}</h4>
          <pre><code>{{ host_bgp.result | replace('\\\\n', '<br/>') }}</code></pre>
          {% endfor -%}
          [/code]
