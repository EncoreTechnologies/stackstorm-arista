version: '2.0'

arista.cli:
  type: direct
  input:
    - hosts
    - command
    - raw

  tasks:
    dispatch:
      action: core.noop
      on-success:
        - make_command_output_json: "{{ not _.raw }}"
        - run_cli: "{{ _.raw }}"
          
    make_command_output_json:
      action: core.noop
      publish:
        command: "{{ _.command }} | json"
      on-success:
        - run_cli

    run_cli:
      action: napalm.cli
      with-items: "hostname in {{ _.hosts }}"
      input:
        hostname: "{{ _.hostname }}"
        commands:
          - "{{ _.command }}"
      publish:
        cli_result: "{{ task('run_cli').result | map(attribute='result.raw') | list }}"
      on-success:
        - filter_cli

    filter_cli:
      action: arista.filter_cli
      input:
        cli_result: "{{ _.cli_result }}"
        command: "{{ _.command }}"
        hosts: "{{ _.hosts }}"
        raw: "{{ _.raw }}"
      publish:
        cli_result_filtered: "{{ task('filter_cli').result.result }}"

  output:
    result: "{{ _.cli_result_filtered }}"
    raw: "{{ _.raw }}"
